<!DOCTYPE html>
<html lang="en">
	<body>
		<h1 align="center">Volume Fader in Decibels</h1>
		<p align="center" id="theButtons">
			<button type="button" id="stopButton" onclick="stopSound()">Stop</button>&nbsp;&nbsp;<button type="button" id="startButton" onclick="startSound()">Start</button>
		</p>
		<p>&nbsp;</p>
		<p align="center" id="theFader">
			<button type="button" id="fadeOut" onclick="fadeOut()">Fade Out</button>&nbsp;&nbsp;<input type="range" id="volumeFader" name="volume" min="0" max="100" value="100" step="1" oninput="setUserVolume(this.value)"/>&nbsp;&nbsp;<button  type="button" id="fadeIn" onclick="fadeIn()">Fade In</button>
			<br/><br/>
			Fade Time:&nbsp;<input type="number" id="fadeTime" style="width: 30px" min="1" max="60" value="1" onchange="setFadeInterval(this.value)"/> seconds
		</p>
		<p align="center" id="userInfo"></p>
		<br/>
		<hr align="center" width="50%"/>
		<div id="explanation">
			<p>
				This page demonstrates a way to give a user control over the volume of a sound with a fader (a.k.a. a slider). The HTML element <span style="font-family: monospace">&lt;input&gt;</span> with <i>type=&quot;range&quot;</i> is the easiest way to put a slider in your web page. In this example, the range of the slider is 0 to 100 (the default), and the <span style="font-family: monospace">volume</span> property of an <span style="font-family: monospace">&lt;audio&gt;</span> element can have a value from 0 (silence) to 1 (full volume). To make the change in the slider correspond well to our subjective sense of loudness, in JavaScript we need to map the slider value to the 0-to-1 range of volume using an exponential mapping. (Our subjective sense of loudness is proportional to the logarithm of the amplitude, so in order to have a linear sense of change in loudness, the change in amplitude should follow an exponential curve.) So as the slider goes from 100 down to 1, we change the volume from 0 dB down to -49.5 dB in increments of 0.5 decibel. When the slider is at 0, instead of going to -50 dB, which is very soft but not totally off, we simply set the volume to 0 (which would be -INF dB). Note that we use the &quot;oninput&quot; event of the slider for continual updating every time the user moves the slider to a different value, rather than the &quot;onchange&quot; event, which occurs only once when the user releases the slider.
			</p>
			<p>
				The page also demonstrates a way to do a timed fade-in or fade-out, using the <span style="font-family: monospace">setInterval()</span> method in JavaScript. The method allows you to specify a function you want to occur repeatedly at regular intervals. The minimum interval between repetitions is 10 milliseconds. For a slider with 100 steps, we can therefore pass through every single step in as little as one second. For a fade-out, we move the slider down from its current value to 0 in increments that are 1/100 of the specified fade time. (The fade time is specified by the user in seconds, whereas <span style="font-family: monospace">setInterval()</span> expects an interval to be specified in milliseconds.) We also store the user's setting of the volume slider so that we can fade back to that value for a fade-in. When we reach the destination, we stop the <span style="font-family: monospace">setInterval()</span> method with <span style="font-family: monospace">clearInterval()</span>.
			</p>
		</div>
		<hr align="center" width="50%"/>
		<p align="center" id="author">
			This page was last modified May 1, 2020 by<br/>
			Christopher Dobrian <i><a href="mailto:dobrian@uci.edu">dobrian@uci.edu</a></i>
		</p>
		<audio src="../../sounds/8barsof4@140bpm.wav" id="theSound" loop>
		<script>
			const snd = document.getElementById("theSound");
			const fader = document.getElementById("volumeFader")
			const info = document.getElementById("userInfo");
			let userVolume = 100;
			let fadeInterval = 10;
			function stopSound() {
				snd.pause();
			}
      function startSound() {
        snd.play();
      }
			function setFadeInterval( theFadeTime ) {
				fadeInterval = 10.*theFadeTime;
			}
			function setUserVolume( theVolume ) {
				userVolume = theVolume;
				setVolume( theVolume );
				info.innerHTML = "Sound volume is " + snd.volume.toFixed(3) + ". User volume is " + theVolume + ".";
			}
			function setVolume( theVolume ) {
				if ( theVolume != 0 ) {
					snd.volume = Math.pow(10.,0.025*(theVolume-100));
				}
				else {
					snd.volume = 0.;
				}
			}
			function fadeOut() {
				let theFadeOut = setInterval( doFadeOut, fadeInterval );
				function doFadeOut() {
					if ( fader.value >= fader.step ) {
						fader.value -= fader.step;
						setVolume( fader.value );
						info.innerHTML = "Sound volume is " + snd.volume.toFixed(3) + ". User volume is " + fader.value + ".";
					}
					else {
						clearInterval( theFadeOut );
						setVolume( 0. );
						fader.value = 0;
						info.innerHTML = "Sound volume is " + snd.volume.toFixed(3) + ". User volume is " + fader.value + ".";
					}
				}
			}
			function fadeIn() {
				let theFadeIn = setInterval( doFadeIn, fadeInterval );
				function doFadeIn() {
					console.log( userVolume-fader.step, fader.value );
					if ( fader.value <= userVolume-fader.step ) {
						fader.value = Number(fader.value) + Number(fader.step);
						setVolume( fader.value );
						info.innerHTML = "Sound volume is " + snd.volume.toFixed(3) + ". User volume is " + fader.value + ".";
					}
					else {
						clearInterval( theFadeIn );
						setVolume( userVolume );
						fader.value = userVolume;
						info.innerHTML = "Sound volume is " + snd.volume.toFixed(3) + ". User volume is " + fader.value + ".";
					}
				}
			}
		</script>
	</body>
</html>
